const template=document.createElement("template");template.innerHTML='\n    <style>:host{box-sizing:border-box;display:block;position:relative}.autocomplete-container{box-sizing:border-box;cursor:text;background-color:#fff;border:1px solid #ccc;border-radius:5px;flex-wrap:wrap;align-items:center;min-height:40px;padding:10px 30px 10px 10px;display:flex;position:relative;box-shadow:0 2px 5px #0000001a}.selected-labels-container{box-sizing:border-box;flex-wrap:wrap;gap:5px;padding-right:5px;display:flex}.selected-label{color:#fff;white-space:nowrap;box-sizing:border-box;background-color:#007bff;border-radius:15px;align-items:center;height:fit-content;margin-bottom:5px;margin-right:5px;padding:5px 10px;font-size:.9em;display:inline-flex}.remove-label-btn{cursor:pointer;background-color:#fff3;border-radius:50%;justify-content:center;align-items:center;margin-left:8px;padding:0 3px;font-size:1.1em;font-weight:700;line-height:1;transition:background-color .2s;display:inline-flex}.remove-label-btn:hover{background-color:#fff6}.autocomplete-input{box-sizing:border-box;background-color:#f5f5f5;border:none;border-radius:3px;outline:none;flex-grow:1;align-self:center;min-width:150px;height:fit-content;margin-bottom:5px;padding:7px 8px;font-size:1em}.suggestions-list{z-index:1000;box-sizing:border-box;background-color:#fff;border:1px solid #ccc;border-top:none;border-radius:0 0 5px 5px;max-height:200px;margin:0;padding:0;list-style:none;display:none;position:absolute;top:calc(100% - 1px);left:0;right:0;overflow-y:auto;box-shadow:0 4px 8px #0000001a}.suggestion-item{cursor:pointer;box-sizing:border-box;white-space:nowrap;text-overflow:ellipsis;border-bottom:1px solid #eee;padding:10px;overflow:hidden}.suggestion-item:last-child{border-bottom:none}.suggestion-item:hover,.suggestion-item.highlighted{background-color:#f0f0f0}.suggestion-item.add-new-item{color:#0056b3;font-style:italic;font-weight:700}.suggestion-item.add-new-item:before{content:"+ ";color:#28a745;font-weight:700}.suggestion-item.add-new-item:hover,.suggestion-item.add-new-item.highlighted{color:#003d80;background-color:#e7f2ff}.clear-all-btn{color:#aaa;cursor:pointer;z-index:5;box-sizing:border-box;background-color:#0000;border-radius:3px;padding:2px 4px;font-size:1.4em;font-weight:700;line-height:1;display:none;position:absolute;top:8px;right:8px}.clear-all-btn:hover{color:#333;background-color:#eee}</style>\n    <div class="autocomplete-container" part="container">\n        <div class="selected-labels-container" part="labels-container">\n            </div>\n        <input type="text" class="autocomplete-input" part="input" autocomplete="off" role="combobox" aria-expanded="false" aria-haspopup="listbox"/>\n        <span class="clear-all-btn" part="clear-button" role="button" aria-label="Clear all selections" title="Clear all selections">&times;</span>\n        <ul class="suggestions-list" part="suggestions-list" role="listbox">\n            </ul>\n    </div>\n';class MultiSelectAutocompleteComponent extends HTMLElement{static componentStylesClass="autocomplete-container";static labelsClass="selected-labels-container";static labelClass="selected-label";static removeClass="remove-label-btn";static clearClass="clear-all-btn";static inputClass="autocomplete-input";static suggestionsListClass="suggestions-list";static suggestionItemClass="suggestion-item";static highlightClass="highlighted";static addNewItemClass="add-new-item";static get observedAttributes(){return["placeholder","max-suggestions","suggestions","selected","tag-server","tag-group"]}constructor(){super(),this.allSuggestionsData=[],this.selectedItems=[],this.selectedItemsSet=new Set,this.currentFilteredSuggestions=[],this.highlightedIndex=-1,this._maxSuggestions=10,this._placeholder="Type to search...",this._tagServer=null,this._tagGroup=null,this._initialFetchDone=!1,this.attachShadow({mode:"open"}),this.shadowRoot.appendChild(template.content.cloneNode(!0)),this._wrapperElement=this.shadowRoot.querySelector(`.${MultiSelectAutocompleteComponent.componentStylesClass}`),this._inputElement=this.shadowRoot.querySelector(`.${MultiSelectAutocompleteComponent.inputClass}`),this._selectedLabelsContainer=this.shadowRoot.querySelector(`.${MultiSelectAutocompleteComponent.labelsClass}`),this._clearAllButtonElement=this.shadowRoot.querySelector(`.${MultiSelectAutocompleteComponent.clearClass}`),this._suggestionsListElement=this.shadowRoot.querySelector(`.${MultiSelectAutocompleteComponent.suggestionsListClass}`),this._suggestionsListElement.id=`msa-suggestions-${crypto.randomUUID()}`,this._inputElement.setAttribute("aria-owns",this._suggestionsListElement.id),this._bindEventHandlers()}connectedCallback(){console.log("[MultiSelectAutocompleteComponent] Connected"),this._updateConfigFromAttributes(),this._addEventListeners(),this._renderSelectedLabels(),this._inputElement.placeholder=this._placeholder,this._initialFetchDone||this._fetchInitialTags()}disconnectedCallback(){console.log("[MultiSelectAutocompleteComponent] Disconnected"),this._removeEventListeners()}attributeChangedCallback(e,t,s){if(t!==s){const t=this._tagServer,i=this._tagGroup;this._updateConfigFromAttributes();let n=!1,o=!1;"selected"===e?this._isServerConfigured()&&this._initialFetchDone||(this._parseSelectedAttribute(s),n=!0):"suggestions"===e?(this._parseSuggestionsAttribute(s),"block"===this._suggestionsListElement.style.display&&this._displaySuggestions()):"placeholder"===e?this._inputElement.placeholder=this._placeholder:"tag-server"!==e&&"tag-group"!==e||this._tagServer===t&&this._tagGroup===i||(o=!0),n&&(this._renderSelectedLabels(),"block"===this._suggestionsListElement.style.display&&this._displaySuggestions()),o&&this.isConnected&&(console.log("[MultiSelectAutocompleteComponent] Server config changed, re-fetching initial tags."),this._initialFetchDone=!1,this._fetchInitialTags())}}_bindEventHandlers(){this.boundHandleInput=this._handleInput.bind(this),this.boundHandleKeyDown=this._handleKeyDown.bind(this),this.boundHandleInputClick=this._handleInputClick.bind(this),this.boundHandleDocumentClick=this._handleDocumentClick.bind(this),this.boundHandleContainerClick=this._handleContainerClick.bind(this),this.boundHandleClearAllClick=this._handleClearAllClick.bind(this),this.boundHandleLabelContainerClick=this._handleLabelContainerClick.bind(this)}_updateConfigFromAttributes(){this._placeholder=this.getAttribute("placeholder")||"Type to search...",this._tagServer=this.getAttribute("tag-server"),this._tagGroup=this.getAttribute("tag-group");const e=this.getAttribute("max-suggestions");this._maxSuggestions=e?parseInt(e,10):10,(isNaN(this._maxSuggestions)||this._maxSuggestions<=0)&&(this._maxSuggestions=10),this._isServerConfigured()&&this._initialFetchDone||this.hasAttribute("suggestions")&&this._parseSuggestionsAttribute(this.getAttribute("suggestions")),this.hasAttribute("selected")&&this._parseSelectedAttribute(this.getAttribute("selected"))}_parseSuggestionsAttribute(e){try{this.allSuggestionsData=e?this._processStringArray(JSON.parse(e)):[]}catch(e){console.error('[MultiSelectAutocompleteComponent] Failed to parse "suggestions" attribute JSON.',e),this.allSuggestionsData=[]}}_parseSelectedAttribute(e){try{null!==e&&(this.selectedItems=this._processStringArray(JSON.parse(e)),this.selectedItemsSet=new Set(this.selectedItems.map((e=>e.toLowerCase()))))}catch(e){console.error('[MultiSelectAutocompleteComponent] Failed to parse "selected" attribute JSON.',e),this.selectedItems||(this.selectedItems=[],this.selectedItemsSet=new Set)}}_processStringArray(e){if(!Array.isArray(e))return[];const t=new Set;return e.map((e=>"string"==typeof e?e.trim():"")).filter((e=>e.length>0)).filter((e=>{const s=e.toLowerCase();return!t.has(s)&&(t.add(s),!0)}))}_addEventListeners(){this._inputElement.addEventListener("input",this.boundHandleInput),this._inputElement.addEventListener("keydown",this.boundHandleKeyDown),this._inputElement.addEventListener("click",this.boundHandleInputClick),this._selectedLabelsContainer.addEventListener("click",this.boundHandleLabelContainerClick),this._clearAllButtonElement.addEventListener("click",this.boundHandleClearAllClick),this._wrapperElement.addEventListener("click",this.boundHandleContainerClick),document.addEventListener("click",this.boundHandleDocumentClick,!0)}_removeEventListeners(){this._inputElement?.removeEventListener("input",this.boundHandleInput),this._inputElement?.removeEventListener("keydown",this.boundHandleKeyDown),this._inputElement?.removeEventListener("click",this.boundHandleInputClick),this._selectedLabelsContainer?.removeEventListener("click",this.boundHandleLabelContainerClick),this._clearAllButtonElement?.removeEventListener("click",this.boundHandleClearAllClick),this._wrapperElement?.removeEventListener("click",this.boundHandleContainerClick),document.removeEventListener("click",this.boundHandleDocumentClick,!0)}_handleInput(){this._inputElement.value.trim().length>0?(this.highlightedIndex=-1,this._displaySuggestions()):this._hideSuggestions()}_handleInputClick(e){this._inputElement.value.trim().length>0&&this._displaySuggestions(),e.stopPropagation()}_handleLabelContainerClick(e){if(e.target.classList.contains(MultiSelectAutocompleteComponent.removeClass)){e.stopPropagation();const t=e.target.closest(`.${MultiSelectAutocompleteComponent.labelClass}`);if(t&&t.dataset.value){this.removeItem(t.dataset.value)&&(this._displaySuggestions(),this._inputElement.focus())}}else e.target!==this._selectedLabelsContainer&&e.target!==this._wrapperElement||this._inputElement.focus()}_handleClearAllClick(e){e.stopPropagation(),this.clearSelection(),this._inputElement.focus()}_handleContainerClick(e){e.target===this._wrapperElement&&this._inputElement.focus(),e.stopPropagation()}_handleDocumentClick(e){this.shadowRoot.contains(e.target)||this.contains(e.target)||this._hideSuggestions()}_handleKeyDown(e){const t="block"===this._suggestionsListElement.style.display,s=t?this._suggestionsListElement.querySelectorAll(`.${MultiSelectAutocompleteComponent.suggestionItemClass}`):[],i=s.length;let n=!1;switch(e.key){case"ArrowDown":if(n=!0,!t&&this._inputElement.value.trim().length>0){this.highlightedIndex=-1,this._displaySuggestions();this._suggestionsListElement.querySelectorAll(`.${MultiSelectAutocompleteComponent.suggestionItemClass}`).length>0&&(this.highlightedIndex=0,this._updateHighlight())}else t&&i>0&&(this.highlightedIndex=(this.highlightedIndex+1)%i,this._updateHighlight());break;case"ArrowUp":n=!0,t&&i>0&&(this.highlightedIndex=(this.highlightedIndex-1+i)%i,this._updateHighlight());break;case" ":if(t&&this.highlightedIndex>-1&&i>0){n=!0;const e=s[this.highlightedIndex];if(e){const t=e.dataset.addNewValue||e.textContent;if(t){this.addItem(t)&&(this._inputElement.value="",this.highlightedIndex=-1,this._displaySuggestions()),this._inputElement.focus()}}}else n=!1;break;case"Enter":n=!0;let e=null;if(t&&this.highlightedIndex>-1&&s[this.highlightedIndex]){const t=s[this.highlightedIndex];e=t.dataset.addNewValue||t.textContent}else{const t=this._inputElement.value.trim();if(t.length>0){const s=this.allSuggestionsData.some((e=>e.toLowerCase()===t.toLowerCase())),i=this.selectedItemsSet.has(t.toLowerCase());s||i||(e=t)}}e&&this.addItem(e),this._inputElement.value="",this._hideSuggestions();break;case"Escape":t&&(n=!0,this._hideSuggestions());break;case"Backspace":if(""===this._inputElement.value&&this.selectedItems.length>0){n=!0;const e=this.selectedItems[this.selectedItems.length-1];this.removeItem(e)&&this._displaySuggestions()}else this.highlightedIndex=-1,t&&this._updateHighlight(!1);break;default:this.highlightedIndex=-1,t&&this._updateHighlight(!1)}n&&e.preventDefault()}_renderSelectedLabels(){const e=document.createDocumentFragment();this.selectedItems.forEach((t=>{const s=document.createElement("span");s.className=MultiSelectAutocompleteComponent.labelClass,s.textContent=t,s.dataset.value=t,s.setAttribute("part","selected-label");const i=document.createElement("span");i.className=MultiSelectAutocompleteComponent.removeClass,i.innerHTML="&times;",i.title=`Remove ${t}`,i.setAttribute("role","button"),i.setAttribute("aria-label",`Remove ${t}`),i.setAttribute("part","remove-button"),i.tabIndex=-1,s.appendChild(i),e.appendChild(s)})),this._selectedLabelsContainer.innerHTML="",this._selectedLabelsContainer.appendChild(e),this._clearAllButtonElement.style.display=this.selectedItems.length>0?"inline-block":"none"}_displaySuggestions(){const e=this._inputElement.value.trim(),t=e.toLowerCase();this._suggestionsListElement.innerHTML="",this.currentFilteredSuggestions=[],t.length>0?this.currentFilteredSuggestions=this.allSuggestionsData.filter((e=>!this.selectedItemsSet.has(e.toLowerCase())&&e.toLowerCase().includes(t))):this.currentFilteredSuggestions=this.allSuggestionsData.filter((e=>!this.selectedItemsSet.has(e.toLowerCase())));const s=document.createDocumentFragment();let i=!1;if(e.length>0){const e=this.allSuggestionsData.some((e=>e.toLowerCase()===t)),s=this.selectedItemsSet.has(t);i=!e&&!s}if(i){const t=this._createSuggestionLi(`Add "${e}"`,`${MultiSelectAutocompleteComponent.suggestionItemClass} ${MultiSelectAutocompleteComponent.addNewItemClass}`,`${this._suggestionsListElement.id}-addnew`);t.dataset.addNewValue=e,t.setAttribute("part","suggestion-item add-new-item"),t.addEventListener("click",(t=>{t.stopPropagation(),this.addItem(e),this._inputElement.value="",this._hideSuggestions()})),s.appendChild(t)}if(this.currentFilteredSuggestions.slice(0,this._maxSuggestions).forEach(((e,t)=>{const i=this._createSuggestionLi(e,MultiSelectAutocompleteComponent.suggestionItemClass,`${this._suggestionsListElement.id}-item-${t}`);i.setAttribute("part","suggestion-item"),i.addEventListener("click",(t=>{t.stopPropagation(),this.addItem(e),this._inputElement.value="",this._hideSuggestions()})),s.appendChild(i)})),s.hasChildNodes()){if(this._suggestionsListElement.appendChild(s),this.highlightedIndex<0)this._updateHighlight(!1);else{const e=this._suggestionsListElement.querySelectorAll(`.${MultiSelectAutocompleteComponent.suggestionItemClass}`);this.highlightedIndex=Math.min(this.highlightedIndex,e.length-1),this.highlightedIndex<0&&(this.highlightedIndex=-1),this._updateHighlight(!1)}this._suggestionsListElement.style.display="block",this._inputElement.setAttribute("aria-expanded","true")}else this._hideSuggestions()}_createSuggestionLi(e,t,s){const i=document.createElement("li");return i.className=t,i.textContent=e,i.setAttribute("role","option"),i.id=s,i}_hideSuggestions(){"none"!==this._suggestionsListElement.style.display&&(this._suggestionsListElement.style.display="none",this._inputElement.setAttribute("aria-expanded","false"),this._inputElement.removeAttribute("aria-activedescendant"),this.highlightedIndex=-1)}_updateHighlight(e=!0){const t=this._suggestionsListElement.querySelectorAll(`.${MultiSelectAutocompleteComponent.suggestionItemClass}`);let s=null;t.forEach(((t,i)=>{const n=i===this.highlightedIndex;t.classList.toggle(MultiSelectAutocompleteComponent.highlightClass,n),t.setAttribute("aria-selected",n?"true":"false"),n&&(s=t.id,e&&requestAnimationFrame((()=>{null!==t.offsetParent&&t.scrollIntoView({block:"nearest"})})))})),s?this._inputElement.setAttribute("aria-activedescendant",s):this._inputElement.removeAttribute("aria-activedescendant")}_isServerConfigured(){return!(!this._tagServer||!this._tagGroup)}async _fetchInitialTags(){if(!this._isServerConfigured())return console.log("[MultiSelectAutocompleteComponent] Server not configured, skipping initial fetch."),void(this._initialFetchDone=!0);const e=`${this._tagServer}/${this._tagGroup}`;console.log(`[MultiSelectAutocompleteComponent] Fetching tag choices from: ${e}`);try{const t=await fetch(e,{method:"GET",headers:{Accept:"application/json, text/plain"}});if(!t.ok)throw new Error(`HTTP error! Status: ${t.status} ${t.statusText}`);const s=t.headers.get("content-type");let i=[];if(s&&s.includes("application/json")){const e=await t.json();i=Array.isArray(e)?this._processStringArray(e):[],Array.isArray(e)||console.warn("[MultiSelectAutocompleteComponent] Received JSON is not an array.")}else{const e=await t.text();i=this._processStringArray(e.split("\n"))}console.log(`[MultiSelectAutocompleteComponent] Fetched ${i.length} tag choices.`),this.allSuggestionsData=[...i],this._initialFetchDone=!0}catch(e){console.error("[MultiSelectAutocompleteComponent] Failed to fetch tag choices:",e),this._initialFetchDone=!0}finally{this._hideSuggestions()}}async _syncAllTagsToServer(){if(!this._isServerConfigured())return void console.warn("[MultiSelectAutocompleteComponent] Attempted to sync tags, but server is not configured.");const e=`${this._tagServer}/${this._tagGroup}`,t=[...this.selectedItems];console.log(`[MultiSelectAutocompleteComponent] Syncing ${t.length} tags to ${e}...`);try{const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(s.ok)console.log(`[MultiSelectAutocompleteComponent] Successfully synced tags for group '${this._tagGroup}'.`);else{let e=s.statusText;try{e+=` - ${await s.text()}`}catch(e){}console.error(`[MultiSelectAutocompleteComponent] Error syncing tags for group '${this._tagGroup}'. Status: ${s.status}. ${e}`)}}catch(e){console.error(`[MultiSelectAutocompleteComponent] Network error syncing tags for group '${this._tagGroup}':`,e)}}addItem(e){const t=e?.trim();if(!t)return!1;const s=t.toLowerCase();if(!this.selectedItemsSet.has(s)){this.selectedItems.push(t),this.selectedItemsSet.add(s);return new Set(this.allSuggestionsData.map((e=>e.toLowerCase()))).has(s)||this.allSuggestionsData.push(t),this._renderSelectedLabels(),this.dispatchEvent(new CustomEvent("add",{bubbles:!0,composed:!0,detail:{item:t}})),!0}return!1}removeItem(e){if(!e)return!1;const t=e.toLowerCase();if(this.selectedItemsSet.has(t)){const s=this.selectedItems.find((e=>e.toLowerCase()===t));return this.selectedItems=this.selectedItems.filter((e=>e.toLowerCase()!==t)),this.selectedItemsSet.delete(t),this._renderSelectedLabels(),this.dispatchEvent(new CustomEvent("remove",{bubbles:!0,composed:!0,detail:{item:s||e}})),!0}return!1}clearSelection(){if(0===this.selectedItems.length)return;const e=[...this.selectedItems];this.selectedItems=[],this.selectedItemsSet.clear(),this._renderSelectedLabels(),this._displaySuggestions(),this.dispatchEvent(new CustomEvent("clearall",{bubbles:!0,composed:!0,detail:{removedItems:e}}))}getSelectedItems(){return this._isServerConfigured()?this._syncAllTagsToServer():console.log("[MultiSelectAutocompleteComponent] getSelectedItems: server not configured. Skipping sync."),[...this.selectedItems]}setSuggestions(e){this.allSuggestionsData=this._processStringArray(e),"block"!==this._suggestionsListElement.style.display&&this.shadowRoot.activeElement!==this._inputElement||this._displaySuggestions()}setSelected(e){this.selectedItems=this._processStringArray(e),this.selectedItemsSet=new Set(this.selectedItems.map((e=>e.toLowerCase()))),this._renderSelectedLabels(),"block"!==this._suggestionsListElement.style.display&&this.shadowRoot.activeElement!==this._inputElement||this._displaySuggestions()}}window.customElements.get("multi-select-autocomplete")||window.customElements.define("multi-select-autocomplete",MultiSelectAutocompleteComponent);